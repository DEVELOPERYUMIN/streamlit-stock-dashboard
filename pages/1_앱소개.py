import streamlit as st

st.set_page_config(page_title="주식 기초", layout="wide")

st.title("앱 소개")

st.subheader("1) 이 앱이 하는 일")
st.markdown(
"""
- KRX 상장사 목록에서 회사명을 검색하고 종목을 선택한다.
- 선택한 기간의 주가 데이터를 조회한다.
- 종가(기본), 이동평균선(MA20/MA60), 거래량(보조축)을 선택적으로 표시한다.
- 기간 요약(최근 종가/기간 수익률/최고·최저/최대낙폭/변동성)을 카드로 제공한다.
- 최대낙폭(MDD)이 발생한 구간(고점→저점)을 음영 및 마커로 강조한다.
- 조회 결과를 엑셀 파일로 다운로드한다.
- 종가 라인을 시간 순서대로 점진적으로 그리는 애니메이션을 제공한다.
"""
)

st.subheader("2) 이 앱이 하지 않는 일")
st.markdown(
"""
- 매수/매도 추천, 목표가 제시, 투자 판단 대행을 하지 않는다.
- 실시간(초단타) 체결 단위 데이터 제공을 하지 않는다. (일자 단위 시계열 기준)
- 뉴스/공시/재무제표 기반의 펀더멘털 분석을 자동으로 수행하지 않는다.
"""
)

st.subheader("3) 앱 내부 동작 - 데이터 흐름 및 처리 과정")
st.markdown(
    """
1. **KRX 상장사 목록 로딩(캐시)**
   - KRX KIND에서 상장사 목록을 가져와 `회사명 ↔ 종목코드` 데이터프레임을 생성한다.
   - `st.cache_data(ttl=1시간)`으로 캐싱하여 반복 호출 비용을 줄인다.

2. **회사명 검색 → 종목 선택**
   - 키워드로 회사명을 필터링(포함 검색)한다.
   - `startswith` 결과를 우선 정렬하여 검색 UX를 개선한다.
   - 선택된 항목에서 `회사명`, `종목코드`를 파싱한다.

3. **종목코드 정규화/검증**
   - 종목코드가 **숫자만 포함**하는지 정규식으로 검사한다.
   - 길이가 6자리를 넘으면 오류 처리한다.
   - `zfill(6)`로 6자리로 정규화한다.  
   → **Yahoo 등 다른 경로로 빠질 수 있는 입력을 사전에 차단**한다.

4. **기간 선택(시작/종료) 가드 처리**
   - `st.date_input` 결과가 **2개(기간)** 인지 확인한다.
   - `start_dt > end_dt`이면 즉시 경고하고 중단한다.

5. **주가 데이터 조회**
   - `FinanceDataReader.DataReader(stock_code, start_date, end_date)`로 데이터를 수집한다.
   - 데이터가 비어 있으면 안내 후 중단한다.

6. **전처리 및 파생 지표 계산**
   - 인덱스(Date)를 컬럼 `date`로 변환(`reset_index` 후 rename)한다.
   - 이동평균선(MA20/MA60)을 계산한다.
   - 기간이 너무 짧아 MA가 전부 NaN이면 해당 MA 옵션을 자동 OFF하고 안내한다.
   - 요약 지표를 계산한다:
     - 기간 수익률(첫 종가 대비 마지막 종가)
     - 최고/최저 종가
     - MDD(Max Drawdown)
     - 일간 변동성(일간 수익률 표준편차)

7. **요약 카드 렌더링**
   - `st.metric`으로 최근 종가/기간 수익률/최고/최저/MDD/변동성을 표시한다.

8. **Plotly Figure 생성 및 레이아웃 설정**
   - `hovermode="x unified"`로 같은 날짜의 값이 한 번에 보이도록 통합한다.
   - `rangeslider`는 OFF로 고정한다.
   - 거래량은 `yaxis2(보조축)`에 overlay하여 표시할 수 있게 설정한다.

9. **트레이스 추가**
   - Close 라인(기본) + (선택) MA20/MA60 라인을 추가한다.
   - (선택) 거래량 Volume을 Bar로 그리고 보조축(y2)에 표시한다.
   - Hover 템플릿은 Close 트레이스에서 `customdata`를 사용해 필요한 값(예: 거래량 등)을 함께 표시한다.

10. **(선택) MDD 구간 강조**
   - 최대낙폭이 발생한 **고점(peak) → 저점(trough)** 구간을 계산한다.
   - 해당 구간을 붉은 음영(vrect)으로 표시한다.
   - peak/trough 마커 + 라벨을 추가해 직관적인 해석을 돕는다.

11. **(선택) Close 타임-플레이 애니메이션**
   - 성능을 위해 최근 구간(최대 `MAX_FRAMES=260`)으로 제한한다.
   - `frames`를 구성해 종가 라인이 순차적으로 그려지도록 설정한다.
   - Play/Pause 버튼으로 재생을 제어한다.

12. **결과 출력 및 다운로드**
   - 데이터 테이블(최근 10개)을 렌더링한다.
   - Plotly 차트를 렌더링한다.
   - 조회 데이터를 엑셀로 변환해 `st.download_button`으로 다운로드를 제공한다.
"""
)